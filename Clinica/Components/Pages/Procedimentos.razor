@page "/procedimentos"
@using Clinica.Data
@using Clinica.Components.Pages.Dialog
@using Clinica.Components.Pages.Dialog.Procedimentos
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

@inject ApplicationDbContextClinica Db
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject NotificationService NotificationService

@rendermode InteractiveServer

<style>
    .gradientColor{
    background: linear-gradient(90deg,rgba(42, 51, 155, 1) 0%, rgba(87, 171, 199, 1) 50%, rgba(42, 51, 155, 1) 100%);
    -webkit-background-clip: text; /* Para navegadores baseados em WebKit (Chrome, Safari) */
    background-clip: text;
    color: transparent; /* Torna a cor do texto transparente para que o gradiente apare√ßa */
    display: inline-block; /* Importante para que o gradiente se aplique corretamente ao texto */
    }

    .gradientColorEmail{
    background: #2a649b;
    background: linear-gradient(90deg, rgba(42, 100, 155, 1) 0%, rgba(47, 107, 160, 1) 0%, rgba(87, 171, 199, 1) 50%, rgba(42, 108, 155, 1) 100%);
    }

</style>


<h3 class="gradientColor" style="margin-bottom: 2px;">Procedimentos dispon√≠veis</h3>
<div style="
    width: 250px;
    height: 3px;
    background: linear-gradient(90deg,rgba(42, 51, 155, 1) 0%, rgba(87, 171, 199, 1) 50%, rgba(42, 51, 155, 1) 100%); /* Ajuste as cores do degrad√™ */
    border-radius: 2px;
    margin-top: 0;
"></div>
<br/>



<RadzenTextBox @bind-Value="filtro" Placeholder="üîç Pesquisar procedimento..." Style="width: 300px; margin-bottom: 20px;" />

<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.8rem;">
    @foreach (var item in Procedimento.Where(p => string.IsNullOrEmpty(filtro) || p.Nome.Contains(filtro, StringComparison.OrdinalIgnoreCase)))
    {
        <RadzenCard Style="display: flex; flex-direction: column; min-height: 200px; padding: 0.6rem;">
            <div style="text-align: center; min-height: 35px; display: flex; align-items: center; justify-content: center; margin-bottom: 0.4rem;">
                <h6 class="gradientColor" style="margin: 0; font-size: 0.75rem; font-weight: 600; line-height: 1.2;">@item.Nome</h6>
            </div>
            <img src="@item.UrlImage" alt="@item.Nome" style="width: 100%; height: 80px; object-fit: cover; border-radius: 4px; margin-bottom: 0.4rem;"/>
            <div style="flex-grow: 1; display: flex; align-items: center; margin-bottom: 0.4rem;">
                <p style="margin: 0; font-size: 0.7rem;"><strong>Pre√ßo:</strong> @item.Preco.ToString("C")</p>
            </div>
            <div style="display: flex; gap: 0.3rem;">
                <RadzenButton
                Text="Agendar"
                Icon="add_circle"
                ButtonStyle="ButtonStyle.Primary"
                Size="ButtonSize.ExtraSmall"
                Style="flex: 1; font-size: 0.46rem; padding: 0.3rem;"
                Click="@(args => AbrirDialogAgendamento(item))"
                />
                <RadzenButton
                Text="Excluir"
                Icon="remove"
                ButtonStyle="ButtonStyle.Danger"
                Size="ButtonSize.ExtraSmall"
                Style="flex: 1; font-size: 0.46rem; padding: 0.3rem;"
                Click="@(args => ExcluirProcedimento(item))"
                />
            </div>
        </RadzenCard>
    }
</div>

<!-- Bot√£o flutuante -->
<div style="position: fixed; top: 40px; right: 30px; z-index: 1000;">
    <RadzenButton
    Text="Adicionar"
    Icon="add"
    ButtonStyle="ButtonStyle.Success"
    Size="ButtonSize.Medium"
    Click="@AbrirDialog" />
</div>

@code {
    List<Procedimento> Procedimento;
    string filtro = "";

    protected override async Task OnInitializedAsync()
    {
        Procedimento = await Db.Procedimentos.ToListAsync();
    }
    List<Agendamento> appointments = new();

    async Task AbrirDialogAgendamento(Procedimento procedimento)
    {
        try
        {
            var start = DateTime.Now;
            var end = start.AddHours(1);
           

            var data = await DialogService.OpenAsync<AddAppointment>(
                $"Novo Agendamento - {procedimento.Nome}", 
                new Dictionary<string, object>
                {
                    { "Start", start },
                    { "End", end },
                    { "Procedimento", procedimento } // passa objeto inteiro
                }
            );

            if (data != null)
            {
                appointments ??= new List<Agendamento>();
                appointments.Add(data);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Erro ao abrir agendamento", ex.Message);
        }
    }

    
    async Task AbrirDialog()
    {
        var result = await DialogService.OpenAsync<AddProcedimento>(
            "Novo Procedimento",
            null,
            new DialogOptions() { Width = "500px", Height = "auto" }
        );

        // Atualiza lista se salvar
        if (result is Procedimento novo)
        {
            Procedimento.Add(novo);
            StateHasChanged();
        }
    }

    async Task ExcluirProcedimento(Procedimento procedimento)
    {
        try
        {
            var confirmado = await DialogService.Confirm(
                $"Tem certeza que deseja excluir o procedimento '{procedimento.Nome}'?",
                "Confirmar Exclus√£o",
                new ConfirmOptions() { OkButtonText = "Sim", CancelButtonText = "N√£o" }
            );

            if (confirmado == true)
            {
                // Remove do banco de dados
                Db.Procedimentos.Remove(procedimento);
                await Db.SaveChangesAsync();

                // Remove da lista local
                Procedimento.Remove(procedimento);

                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Procedimento exclu√≠do",
                    Detail = $"O procedimento '{procedimento.Nome}' foi exclu√≠do com sucesso.",
                    Duration = 3000
                });

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Erro ao excluir",
                Detail = ex.Message,
                Duration = 5000
            });
        }
    }
}

