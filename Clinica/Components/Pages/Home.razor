@page "/home"
@using Clinica.Data
@using Clinica.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject ApplicationDbContextClinica Db

@rendermode InteractiveServer

<PageTitle>Dashboard - Clínica</PageTitle>

<style>
    .gradientColor{
        background: linear-gradient(90deg,rgba(42, 51, 155, 1) 0%, rgba(87, 171, 199, 1) 50%, rgba(42, 51, 155, 1) 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        display: inline-block;
    }

    .card-stat {
        background: linear-gradient(135deg, rgba(42, 51, 155, 0.1) 0%, rgba(87, 171, 199, 0.1) 100%);
        border-left: 4px solid;
        padding: 1.5rem;
        border-radius: 8px;
    }

    .card-stat.blue {
        border-left-color: #2a339b;
    }

    .card-stat.green {
        border-left-color: #28a745;
    }

    .card-stat.orange {
        border-left-color: #fd7e14;
    }

    .card-stat.purple {
        border-left-color: #6f42c1;
    }
</style>

<h3 class="gradientColor" style="margin-bottom: 0.5rem;">Dashboard - Visão Geral</h3>
<div style="
    width: 200px;
    height: 3px;
    background: linear-gradient(90deg,rgba(42, 51, 155, 1) 0%, rgba(87, 171, 199, 1) 50%, rgba(42, 51, 155, 1) 100%);
    border-radius: 2px;
    margin-bottom: 2rem;
"></div>

@if (isLoading)
{
    <div style="display: flex; justify-content: center; align-items: center; height: 400px;">
        <RadzenProgressBarCircular ShowValue="true" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large">
            <Template>Carregando...</Template>
        </RadzenProgressBarCircular>
    </div>
}
else
{
    <!-- Cards de Estatísticas -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="card-stat blue">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h6 style="margin: 0; color: #666; font-size: 0.9rem;">Total de Clientes</h6>
                    <h2 style="margin: 0.5rem 0 0 0; color: #2a339b; font-weight: bold;">@totalClientes</h2>
                </div>
                <RadzenIcon Icon="people" Style="font-size: 3rem; color: rgba(42, 51, 155, 0.3);" />
            </div>
        </div>

        <div class="card-stat green">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h6 style="margin: 0; color: #666; font-size: 0.9rem;">Agendamentos Hoje</h6>
                    <h2 style="margin: 0.5rem 0 0 0; color: #28a745; font-weight: bold;">@agendamentosHoje</h2>
                </div>
                <RadzenIcon Icon="event" Style="font-size: 3rem; color: rgba(40, 167, 69, 0.3);" />
            </div>
        </div>

        <div class="card-stat orange">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h6 style="margin: 0; color: #666; font-size: 0.9rem;">Próximos 7 Dias</h6>
                    <h2 style="margin: 0.5rem 0 0 0; color: #fd7e14; font-weight: bold;">@agendamentosProximosDias</h2>
                </div>
                <RadzenIcon Icon="schedule" Style="font-size: 3rem; color: rgba(253, 126, 20, 0.3);" />
            </div>
        </div>

        <div class="card-stat purple">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h6 style="margin: 0; color: #666; font-size: 0.9rem;">Total Procedimentos</h6>
                    <h2 style="margin: 0.5rem 0 0 0; color: #6f42c1; font-weight: bold;">@totalProcedimentos</h2>
                </div>
                <RadzenIcon Icon="medical_services" Style="font-size: 3rem; color: rgba(111, 66, 193, 0.3);" />
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <RadzenCard Style="padding: 1rem;">
            <h5 class="gradientColor" style="margin-bottom: 0.5rem; font-size: 1rem;">Agendamentos por Status</h5>
            <RadzenChart Style="height: 250px;">
                <RadzenPieSeries Data="@agendamentosPorStatus" Title="Quantidade" CategoryProperty="Status" ValueProperty="Quantidade" Fills="@GetStatusColors()">
                    <RadzenSeriesDataLabels Visible="true" />
                </RadzenPieSeries>
            </RadzenChart>
        </RadzenCard>

        <RadzenCard Style="padding: 1rem;">
            <h5 class="gradientColor" style="margin-bottom: 0.5rem; font-size: 1rem;">Procedimentos Mais Agendados</h5>
            <RadzenChart Style="height: 250px;">
                <RadzenBarSeries Data="@procedimentosMaisAgendados" CategoryProperty="Nome" ValueProperty="Quantidade" Title="Agendamentos" Fill="#6f42c1">
                    <RadzenSeriesDataLabels Visible="true" />
                </RadzenBarSeries>
                <RadzenValueAxis>
                    <RadzenGridLines Visible="true" />
                    <RadzenAxisTitle Text="Quantidade" />
                </RadzenValueAxis>
                <RadzenCategoryAxis>
                    <RadzenGridLines Visible="false" />
                </RadzenCategoryAxis>
            </RadzenChart>
        </RadzenCard>
    </div>

    <!-- Lista de Clientes Recentes -->
    <RadzenCard Style="padding: 1.5rem; margin-bottom: 2rem;">
        <h5 class="gradientColor" style="margin-bottom: 1rem;">Clientes Recentes</h5>
        <RadzenDataGrid Data="@clientesRecentes" TItem="Cliente" AllowPaging="true" PageSize="5" AllowSorting="true">
            <Columns>
                <RadzenDataGridColumn TItem="Cliente" Property="Nome" Title="Nome" />
                <RadzenDataGridColumn TItem="Cliente" Property="Email" Title="Email" />
                <RadzenDataGridColumn TItem="Cliente" Property="Telefone" Title="Telefone" />
                <RadzenDataGridColumn TItem="Cliente" Property="DataNascimento" Title="Data Nascimento" FormatString="{0:dd/MM/yyyy}" />
                <RadzenDataGridColumn TItem="Cliente" Title="Agendamentos">
                    <Template Context="cliente">
                        @cliente.Agendamentos.Count
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </RadzenCard>

    <!-- Próximos Agendamentos -->
    <RadzenCard Style="padding: 1.5rem;">
        <h5 class="gradientColor" style="margin-bottom: 1rem;">Próximos Agendamentos</h5>
        <RadzenDataGrid Data="@proximosAgendamentos" TItem="Agendamento" AllowPaging="true" PageSize="10" AllowSorting="true">
            <Columns>
                <RadzenDataGridColumn TItem="Agendamento" Property="DataAgendamento" Title="Data" FormatString="{0:dd/MM/yyyy}" />
                <RadzenDataGridColumn TItem="Agendamento" Title="Horário">
                    <Template Context="agendamento">
                        @agendamento.HoraInicio?.ToString(@"hh\:mm") - @agendamento.HoraFim?.ToString(@"hh\:mm")
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Agendamento" Property="Cliente.Nome" Title="Cliente" />
                <RadzenDataGridColumn TItem="Agendamento" Property="Procedimento.Nome" Title="Procedimento" />
                <RadzenDataGridColumn TItem="Agendamento" Property="Status.StatusText" Title="Status">
                    <Template Context="agendamento">
                        <span style="@GetStatusBadgeColor(agendamento.Status.StatusText)">
                            @agendamento.Status.StatusText
                        </span>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </RadzenCard>
}

@code {
    private bool isLoading = true;

    // Estatísticas
    private int totalClientes = 0;
    private int agendamentosHoje = 0;
    private int agendamentosProximosDias = 0;
    private int totalProcedimentos = 0;

    // Dados para gráficos
    private List<StatusData> agendamentosPorStatus = new();
    private List<ProcedimentoData> procedimentosMaisAgendados = new();

    // Listas
    private List<Cliente> clientesRecentes = new();
    private List<Agendamento> proximosAgendamentos = new();

    protected override async Task OnInitializedAsync()
    {
        await CarregarDados();
        isLoading = false;
    }

    private async Task CarregarDados()
    {
        var hoje = DateTime.Today;
        var proximaSemana = hoje.AddDays(7);

        // Estatísticas
        totalClientes = await Db.Clientes.CountAsync();
        agendamentosHoje = await Db.Agendamentos
            .Where(a => a.DataAgendamento.HasValue && a.DataAgendamento.Value.Date == hoje)
            .CountAsync();
        agendamentosProximosDias = await Db.Agendamentos
            .Include(a => a.Status)
            .Where(a => a.DataAgendamento.HasValue &&
                       a.DataAgendamento.Value.Date >= hoje &&
                       a.DataAgendamento.Value.Date <= proximaSemana &&
                       a.Status.StatusText.ToLower().Contains("pendente"))
            .CountAsync();
        totalProcedimentos = await Db.Procedimentos.CountAsync();

        // Agendamentos por Status
        var statusGroups = await Db.Agendamentos
            .Include(a => a.Status)
            .GroupBy(a => a.Status.StatusText)
            .Select(g => new StatusData { Status = g.Key, Quantidade = g.Count() })
            .ToListAsync();
        agendamentosPorStatus = statusGroups;

        // Procedimentos mais agendados
        var procedimentosGroups = await Db.Agendamentos
            .Include(a => a.Procedimento)
            .Where(a => a.Procedimento != null)
            .GroupBy(a => a.Procedimento!.Nome)
            .Select(g => new ProcedimentoData { Nome = g.Key, Quantidade = g.Count() })
            .OrderByDescending(p => p.Quantidade)
            .Take(5)
            .ToListAsync();
        procedimentosMaisAgendados = procedimentosGroups;

        // Clientes recentes
        clientesRecentes = await Db.Clientes
            .Include(c => c.Agendamentos)
            .OrderByDescending(c => c.Id)
            .Take(10)
            .ToListAsync();

        // Próximos agendamentos
        var agendamentosTemp = await Db.Agendamentos
            .Include(a => a.Cliente)
            .Include(a => a.Procedimento)
            .Include(a => a.Status)
            .Where(a => a.DataAgendamento.HasValue && a.DataAgendamento.Value.Date >= hoje)
            .OrderBy(a => a.DataAgendamento)
            .ToListAsync();

        // Ordena por HoraInicio no lado do cliente (LINQ to Objects)
        proximosAgendamentos = agendamentosTemp
            .OrderBy(a => a.DataAgendamento)
            .ThenBy(a => a.HoraInicio)
            .Take(20)
            .ToList();
    }

    private string GetStatusBadgeColor(string status)
    {
        var statusText = status?.ToLower() ?? "";
        string backgroundColor;
        string textColor = "white";

        if (statusText.Contains("cancelado"))
        {
            backgroundColor = "#dc3545"; // Vermelho
        }
        else if (statusText.Contains("pendente"))
        {
            backgroundColor = "#fd7e14"; // Laranja
        }
        else if (statusText.Contains("concluído") || statusText.Contains("concluido"))
        {
            backgroundColor = "#28a745"; // Verde
        }
        else if (statusText.Contains("confirmado"))
        {
            backgroundColor = "#17a2b8"; // Azul
        }
        else
        {
            backgroundColor = "#6c757d"; // Cinza padrão
        }

        return $"background-color: {backgroundColor}; color: {textColor}; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 500; display: inline-block;";
    }

    private IEnumerable<string> GetStatusColors()
    {
        var colors = new List<string>();

        foreach (var item in agendamentosPorStatus)
        {
            var statusText = item.Status?.ToLower() ?? "";

            if (statusText.Contains("cancelado"))
            {
                colors.Add("#dc3545"); // Vermelho
            }
            else if (statusText.Contains("pendente"))
            {
                colors.Add("#fd7e14"); // Laranja
            }
            else if (statusText.Contains("concluído") || statusText.Contains("concluido"))
            {
                colors.Add("#28a745"); // Verde
            }
            else if (statusText.Contains("confirmado"))
            {
                colors.Add("#17a2b8"); // Azul
            }
            else
            {
                colors.Add("#6c757d"); // Cinza padrão
            }
        }

        return colors;
    }

    public class StatusData
    {
        public string Status { get; set; } = "";
        public int Quantidade { get; set; }
    }

    public class ProcedimentoData
    {
        public string Nome { get; set; } = "";
        public int Quantidade { get; set; }
    }
}
